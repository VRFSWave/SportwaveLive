<script>
    async function fetchLiveGames() {
        try {
            const response = await fetch('https://streamed.su/api/matches/all-today');
            const games = await response.json();

            const gamesContainer = document.getElementById('games-container');
            const searchInput = document.getElementById('search-input');
            const optionsContainer = document.getElementById('options-container');
            const streamOptionsDiv = document.getElementById('stream-options');
            const liveStreamDiv = document.getElementById('live-stream');
            const streamFrame = document.getElementById('stream-frame');

            // Organize games for display
            games.sort((a, b) => new Date(a.date) - new Date(b.date));

            displayGames(games);

            searchInput.addEventListener('input', () => {
                const filteredGames = games.filter(game => 
                    game.title.toLowerCase().includes(searchInput.value.toLowerCase())
                );
                displayGames(filteredGames);
            });

            function displayGames(games) {
                gamesContainer.innerHTML = '';
                games.forEach(game => {
                    const gameDiv = document.createElement('div');
                    gameDiv.className = 'game';

                    const gameDate = new Date(game.date);

                    gameDiv.innerHTML = `
                        <h3>${game.title}</h3>
                        <p class="date">${gameDate.toLocaleDateString()}</p>
                        <p class="time">${gameDate.toLocaleTimeString()}</p>
                        <button class="watch-button" onclick="fetchStreams('${game.id}', ${JSON.stringify(game.sources)})">Watch Now</button>
                    `;

                    gamesContainer.appendChild(gameDiv);
                });
            }

            window.fetchStreams = async (gameId, sources) => {
                try {
                    let streams = [];

                    for (let source of sources) {
                        const response = await fetch(`https://streamed.su/api/stream/${source}/${gameId}`);
                        const data = await response.json();

                        if (data && data.length > 0) {
                            streams = data;
                            break; // Stop searching if a valid stream is found
                        }
                    }

                    if (streams.length === 0) {
                        alert('No streams available for this game.');
                        return;
                    }

                    optionsContainer.innerHTML = '';

                    streams.forEach((stream, index) => {
                        const streamOption = document.createElement('div');
                        streamOption.className = 'stream-option';

                        streamOption.innerHTML = `
                            <button class="watch-button" onclick="showStream('${gameId}', '${index + 1}', '${stream.source}')">Stream ${index + 1}</button>
                        `;

                        optionsContainer.appendChild(streamOption);
                    });

                    streamOptionsDiv.style.display = 'block';
                    document.getElementById('stream-options').scrollIntoView({ behavior: 'smooth' });
                    liveStreamDiv.style.display = 'none';
                } catch (error) {
                    console.error('Error fetching streams:', error);
                }
            };

            window.showStream = (gameId, streamNo, source) => {
                const embedUrl = `https://embedme.top/embed/${source}/${gameId}/${streamNo}`;
                streamFrame.src = embedUrl;
                streamOptionsDiv.style.display = 'none';
                liveStreamDiv.style.display = 'block';
            };

        } catch (error) {
            console.error('Error fetching live games:', error);
        }
    }

    fetchLiveGames();
</script>
